<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>数据库相关 | Mokou的小书房</title>
    <meta name="generator" content="VuePress 1.5.2">
    
    <meta name="description" content="Mokou,源码解析,前端,Vue,Vue3,Es6,Javascript">
    <link rel="preload" href="/fed-note/assets/css/0.styles.35bbaf6d.css" as="style"><link rel="preload" href="/fed-note/assets/js/app.52597b60.js" as="script"><link rel="preload" href="/fed-note/assets/js/2.666d6ac5.js" as="script"><link rel="preload" href="/fed-note/assets/js/10.bc70263e.js" as="script"><link rel="prefetch" href="/fed-note/assets/js/11.7159faba.js"><link rel="prefetch" href="/fed-note/assets/js/12.c19eadfb.js"><link rel="prefetch" href="/fed-note/assets/js/13.33237a86.js"><link rel="prefetch" href="/fed-note/assets/js/14.c394ef89.js"><link rel="prefetch" href="/fed-note/assets/js/15.3e7e993f.js"><link rel="prefetch" href="/fed-note/assets/js/16.7faac765.js"><link rel="prefetch" href="/fed-note/assets/js/17.e2b5eefc.js"><link rel="prefetch" href="/fed-note/assets/js/18.41427e8c.js"><link rel="prefetch" href="/fed-note/assets/js/19.003cae70.js"><link rel="prefetch" href="/fed-note/assets/js/20.34609147.js"><link rel="prefetch" href="/fed-note/assets/js/21.57c60584.js"><link rel="prefetch" href="/fed-note/assets/js/22.9e0c6173.js"><link rel="prefetch" href="/fed-note/assets/js/23.c0b67ad3.js"><link rel="prefetch" href="/fed-note/assets/js/24.cecd0759.js"><link rel="prefetch" href="/fed-note/assets/js/25.671d6a8e.js"><link rel="prefetch" href="/fed-note/assets/js/26.3d659a5d.js"><link rel="prefetch" href="/fed-note/assets/js/27.e06285ee.js"><link rel="prefetch" href="/fed-note/assets/js/28.6df8b992.js"><link rel="prefetch" href="/fed-note/assets/js/29.efb48b7f.js"><link rel="prefetch" href="/fed-note/assets/js/3.6b6bbf88.js"><link rel="prefetch" href="/fed-note/assets/js/30.7242dfaf.js"><link rel="prefetch" href="/fed-note/assets/js/31.05c59ce0.js"><link rel="prefetch" href="/fed-note/assets/js/32.2be0b486.js"><link rel="prefetch" href="/fed-note/assets/js/33.d07f197e.js"><link rel="prefetch" href="/fed-note/assets/js/34.79a63b7b.js"><link rel="prefetch" href="/fed-note/assets/js/35.f35eaefe.js"><link rel="prefetch" href="/fed-note/assets/js/36.b718a34b.js"><link rel="prefetch" href="/fed-note/assets/js/37.fbd1836a.js"><link rel="prefetch" href="/fed-note/assets/js/38.112e270d.js"><link rel="prefetch" href="/fed-note/assets/js/39.e2b199b9.js"><link rel="prefetch" href="/fed-note/assets/js/4.9c7f0bce.js"><link rel="prefetch" href="/fed-note/assets/js/40.4b21c256.js"><link rel="prefetch" href="/fed-note/assets/js/41.ec6f1a3e.js"><link rel="prefetch" href="/fed-note/assets/js/42.8252ebc0.js"><link rel="prefetch" href="/fed-note/assets/js/43.36fbd0b9.js"><link rel="prefetch" href="/fed-note/assets/js/44.6994e218.js"><link rel="prefetch" href="/fed-note/assets/js/45.b8c25cfc.js"><link rel="prefetch" href="/fed-note/assets/js/46.27a85c55.js"><link rel="prefetch" href="/fed-note/assets/js/47.6d68221a.js"><link rel="prefetch" href="/fed-note/assets/js/48.52486e12.js"><link rel="prefetch" href="/fed-note/assets/js/49.ae3206b3.js"><link rel="prefetch" href="/fed-note/assets/js/5.62355573.js"><link rel="prefetch" href="/fed-note/assets/js/50.389d23ae.js"><link rel="prefetch" href="/fed-note/assets/js/51.de9fda8a.js"><link rel="prefetch" href="/fed-note/assets/js/52.72c80114.js"><link rel="prefetch" href="/fed-note/assets/js/53.7f951e3c.js"><link rel="prefetch" href="/fed-note/assets/js/54.1f85707a.js"><link rel="prefetch" href="/fed-note/assets/js/55.cd47e87e.js"><link rel="prefetch" href="/fed-note/assets/js/56.4a81535c.js"><link rel="prefetch" href="/fed-note/assets/js/57.2b60dbd3.js"><link rel="prefetch" href="/fed-note/assets/js/58.fb4c8819.js"><link rel="prefetch" href="/fed-note/assets/js/59.1a615610.js"><link rel="prefetch" href="/fed-note/assets/js/6.f60d1f00.js"><link rel="prefetch" href="/fed-note/assets/js/60.2decd119.js"><link rel="prefetch" href="/fed-note/assets/js/61.c96def20.js"><link rel="prefetch" href="/fed-note/assets/js/62.3ad40f6a.js"><link rel="prefetch" href="/fed-note/assets/js/63.e4fa9853.js"><link rel="prefetch" href="/fed-note/assets/js/64.7e8f1129.js"><link rel="prefetch" href="/fed-note/assets/js/65.cf8f4241.js"><link rel="prefetch" href="/fed-note/assets/js/66.9769ed7d.js"><link rel="prefetch" href="/fed-note/assets/js/67.de932d65.js"><link rel="prefetch" href="/fed-note/assets/js/68.417bccfc.js"><link rel="prefetch" href="/fed-note/assets/js/69.d04187f2.js"><link rel="prefetch" href="/fed-note/assets/js/7.c752f610.js"><link rel="prefetch" href="/fed-note/assets/js/70.ca39ad53.js"><link rel="prefetch" href="/fed-note/assets/js/71.8b7f0aea.js"><link rel="prefetch" href="/fed-note/assets/js/8.37518ed0.js"><link rel="prefetch" href="/fed-note/assets/js/9.745d67a5.js">
    <link rel="stylesheet" href="/fed-note/assets/css/0.styles.35bbaf6d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fed-note/" class="home-link router-link-active"><img src="/fed-note/mh.jpg" alt="Mokou的小书房" class="logo"> <span class="site-name can-hide">Mokou的小书房</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fed-note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/zhongmeizhi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fed-note/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/zhongmeizhi" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深入浅出 Vue3</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue2 &amp;&amp; React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>计算机基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Flutter实战</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>服务端相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fed-note/java/begin.html" class="sidebar-link">Java常识</a></li><li><a href="/fed-note/java/db.html" aria-current="page" class="active sidebar-link">数据库相关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/fed-note/java/spring_boot.html" class="sidebar-link">SpringBoot</a></li><li><a href="/fed-note/node/NPM.html" class="sidebar-link">NPM机制</a></li><li><a href="https://github.com/zhongmeizhi/z-mock" target="_blank" rel="noopener noreferrer" class="sidebar-link">用Koa2撸一个API Mock<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>简单的API</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="数据库相关"><a href="#数据库相关" class="header-anchor">#</a> 数据库相关</h1> <h3 id="mysql-安装-初始化"><a href="#mysql-安装-初始化" class="header-anchor">#</a> mysql 安装&amp;&amp;初始化</h3> <p><em>安装的mysql版本为 5.7</em></p> <p>安装步骤</p> <ol><li>官网下载 https://dev.mysql.com/downloads/file/?id=484900</li> <li>解压zip包 mysql-8.0.15-winx64</li> <li>配置path环境变量(到bin目录)</li> <li>默认解压后没有my.ini文件，故新增my.ini文件，内容如下<div class="language- extra-class"><pre class="language-text"><code>    [mysql]
    # 设置mysql客户端默认字符集
    default-character-set=utf8
    [mysqld]
    #设置3306端口
    port = 3306
    # 设置mysql的安装目录
    basedir=D:\\soft\\mysql-5.7.25-winx64
    # 允许最大连接数
    max_connections=200
    # 服务端使用的字符集默认为8比特编码的latin1字符集
    character-set-server=utf8
    # 创建新表时将使用的默认存储引擎
    default-storage-engine=INNODB
</code></pre></div></li> <li>以管理员身份(否则没权限)运行cmd，cd到解压目录mysql-8.0.15-winx64</li> <li>执行 <strong>mysqld --initialize-insecure</strong> 以初始化data文件夹</li> <li>执行 <strong>mysqld --install</strong> 安装mysql服务</li> <li>执行 <strong>net start mysql</strong> 启动mysql</li> <li><em>mysql5.7默认有随机密码</em> 密码存放在 data目录下的 xxx.err文件内
<ul><li>搜索password is generated for root@localhost:可以找到默认密码</li></ul></li> <li>执行 <strong>mysql -u root -p</strong> 输入默认密码</li> <li>执行 <strong>SET PASSWORD FOR 'root'@'localhost' = PASSWORD('');</strong> 修改默认root密码为空</li></ol> <h5 id="java连接mysql异常"><a href="#java连接mysql异常" class="header-anchor">#</a> Java连接Mysql异常</h5> <blockquote><p>This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver'.</p></blockquote> <p>将旧版本jdbc.propertiesd的<code>com.mysql.dbc.Driver</code>改成<code>com.mysql.cj.jdbc.Driver</code></p> <blockquote><p>The server time zone value 'ÖÐ¹ú±ê×¼Ê±¼ä' is unrecognized or represents more than one time zone. You must configure either the server or JDBC driver</p></blockquote> <p>需要配置服务器或JDBC驱动程序的时区</p> <p>解决：</p> <ul><li>进入数据库，运行<code>set Global time_zone='+8:00'</code></li></ul> <h3 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h3> <blockquote><p>事务：指访问并可能更新数据库中各种数据项的一个程序执行单元(unit)</p></blockquote> <p>ps: <code>mongodb 4.0</code>版本之后支持事务管理</p> <p>事务的四大特性：</p> <ol><li>原子性（Atomicity）: 事务要么全部完成，要么全部取消。 如果事务崩溃，状态回到事务之前（事务回滚）。</li> <li>隔离性（Isolation）: 如果2个事务 T1 和 T2 同时运行，事务 T1 和 T2 最终的结果是相同的，不管 T1和T2谁先结束。</li> <li>持久性（Durability）: 一旦事务提交，不管发生什么（崩溃或者出错），数据要保存在数据库中。</li> <li>一致性（Consistency）: 只有合法的数据（依照关系约束和函数约束）才能写入数据库。</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">begin</span><span class="token punctuation">;</span> <span class="token comment">-- 开始一个事务</span>

    <span class="token keyword">update</span> <span class="token keyword">table</span> <span class="token keyword">set</span> A <span class="token operator">=</span> A <span class="token operator">-</span> <span class="token number">1</span>亿<span class="token punctuation">;</span> <span class="token comment">-- 伪sql，仅作示意</span>
    <span class="token keyword">update</span> <span class="token keyword">table</span> <span class="token keyword">set</span> B <span class="token operator">=</span> B <span class="token operator">+</span> <span class="token number">1</span>亿<span class="token punctuation">;</span>

    <span class="token comment">-- 其他读写操作</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">-- 提交事务</span>
</code></pre></div><h3 id="并发控制："><a href="#并发控制：" class="header-anchor">#</a> 并发控制：</h3> <p><a href="https://zhuanlan.zhihu.com/p/40211594" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h5 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁</h5> <p>悲观锁：总是假设最坏的情况，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁（先锁再访问 / 修改）</p> <p>ps: Java中 <code>synchronized</code> 和 <code>ReentrantLock</code> 等独占锁就是悲观锁思想的实现。</p> <h5 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h5> <p>乐观锁：总是假设最好的情况，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号机制和CAS算法实现</p> <p>乐观锁的实现机制</p> <ol><li>版本号机制</li></ol> <p>一般是在数据表中加上一个数据版本号 <code>version</code> 字段，表示数据被修改的次数，当数据被修改时，<code>version</code> 值会加一。当线程A要更新数据值时，在读取数据的同时也会读取 <code>version</code> 值，在提交更新时，若刚才读取到的 <code>version</code> 值为当前数据库中的 <code>version</code> 值相等时才更新，否则重试更新操作，直到更新成功。</p> <p>举一个简单的例子：
假设数据库中帐户信息表中有一个 version 字段，当前值为 1 ；而当前帐户余额字段（ balance ）为 $100 。</p> <ol><li>操作员 A 此时将其读出（ version=1 ），并从其帐户余额中扣除 $50（ $100-$50 ）。</li> <li>在操作员 A 操作的过程中，操作员B 也读入此用户信息（ version=1 ），并从其帐户余额中扣除 $20 （ $100-$20 ）。</li> <li>操作员 A 完成了修改工作，将数据版本号加一（ version=2 ），连同帐户扣除后余额（ balance=$50 ），提交至数据库更新，此时由于提交数据版本大于数据库记录当前版本，数据被更新，数据库记录 version 更新为 2 。</li> <li>操作员 B 完成了操作，也将版本号加一（ version=2 ）试图向数据库提交数据（ balance=$80 ），但此时比对数据库记录版本时发现，操作员 B 提交的数据版本号为 2 ，数据库记录当前版本也为 2 ，不满足 “ 提交版本必须大于记录当前版本才能执行更新 “ 的乐观锁策略，因此，操作员 B 的提交被驳回。</li></ol> <p>这样，就避免了操作员 B 用基于 version=1 的旧数据修改的结果覆盖操作员A 的操作结果的可能。</p> <ol start="2"><li>CAS算法</li></ol> <p>CAS算法：即 compare and swap（比较与交换），是一种有名的无锁算法。</p> <p>无锁编程，即不使用锁的情况下实现多线程之间的变量同步，也就是在没有线程被阻塞的情况下实现变量的同步，所以也叫非阻塞同步（Non-blocking Synchronization）。</p> <p>CAS算法涉及到三个操作数</p> <ol><li>需要读写的内存值 <code>V</code></li> <li>进行比较的值 <code>A</code></li> <li>拟写入的新值 <code>B</code></li></ol> <p>当且仅当 <code>V</code> 的值等于 <code>A</code> 时，<code>CAS</code>通过原子方式用新值 <code>B</code> 来更新 <code>V</code> 的值，否则不会执行任何操作（比较和替换是一个原子操作）。一般情况下是一个自旋操作，即不断的重试。</p> <h5 id="乐观锁的缺点"><a href="#乐观锁的缺点" class="header-anchor">#</a> 乐观锁的缺点</h5> <ol><li>ABA 问题</li></ol> <p>如果一个变量V初次读取的时候是A值，并且在准备赋值的时候检查到它仍然是A值，那我们就能说明它的值没有被其他线程修改过了吗？很明显是不能的，因为在这段时间它的值可能被改为其他值，然后又改回A，那CAS操作就会误认为它从来没有被修改过。这个问题被称为CAS操作的 &quot;ABA&quot;问题。</p> <p>JDK 1.5 以后的 <code>AtomicStampedReference</code> 类就提供了此种能力，其中的 <code>compareAndSet</code> 方法就是首先检查当前引用是否等于预期引用，并且当前标志是否等于预期标志，如果全部相等，则以原子方式将该引用和该标志的值设置为给定的更新值。</p> <ol start="2"><li>循环时间长开销大</li></ol> <p>自旋CAS（也就是不成功就一直循环执行直到成功）如果长时间不成功，会给CPU带来非常大的执行开销。</p> <ol start="3"><li>只能保证一个共享变量的原子操作</li></ol> <p>CAS 只对单个共享变量有效，当操作涉及跨多个共享变量时 CAS 无效。但是从 JDK 1.5开始，提供了<code>AtomicReference</code> 类来保证引用对象之间的原子性，你可以把多个变量放在一个对象里来进行 CAS 操作.所以我们可以使用锁或者利用 <code>AtomicReference</code> 类把多个共享变量合并成一个共享变量来操作。</p> <h3 id="数据库索引"><a href="#数据库索引" class="header-anchor">#</a> 数据库索引</h3> <blockquote><p>数据库索引是为了增加查询速度而对表字段附加的一种标识。</p></blockquote> <p><a href="https://zhuanlan.zhihu.com/p/23624390" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>大多数DB厂商实现索引都是基于一种数据结构——B树。B树，是一种<strong>平衡的多叉树</strong>。B树的特点就是适合在磁盘等直接存储设备上组织<strong>动态查找表</strong>。</p> <p>一个没加主键的表，它的数据无序的放置在磁盘存储器上，一行一行的排列的很整齐， 跟我认知中的「表」很接近。如果给表上了主键，那么表在磁盘上的存储结构就由整齐排列的结构转变成了树状结构，也就是上面说的「平衡树」结构，换句话说，就是整个表就变成了一个索引，也就是所谓的 -&gt; <code>聚集索引</code></p> <p><img src="/fed-note/assets/img/indexes.d040eb02.jpg" alt="索引"></p> <h5 id="索引的种类"><a href="#索引的种类" class="header-anchor">#</a> 索引的种类</h5> <ol><li>聚集索引</li> <li>常规索引，（非聚合索引）</li> <li>覆盖索引，（复合索引、多字段索引查询）</li></ol> <h5 id="索引的好处"><a href="#索引的好处" class="header-anchor">#</a> 索引的好处</h5> <ol><li>通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性</li> <li>可以大大加快数据的检索速度</li> <li>可以加速表和表之间的连接，特别是在实现数据的参考完整性方面特别有意义</li></ol> <h5 id="为什么加索引查找会快？"><a href="#为什么加索引查找会快？" class="header-anchor">#</a> 为什么加索引查找会快？</h5> <p>索引就像书的目录， 通过书的目录就准确的定位到了书籍具体的内容</p> <ul><li>DB在执行一条Sql语句的时候，默认的方式是根据搜索条件进行全表扫描，遇到匹配条件的就加入搜索结果集合。</li> <li>如果我们对某一字段增加索引，查询时就会先去索引列表中一次定位到特定值的行数，大大减少遍历匹配的行数，所以能明显增加查询的速度。</li></ul> <p>假如一张表有一亿条数据 ，需要查找其中某一条数据，按照常规逻辑， 一条一条的去匹配的话， 最坏的情况下需要匹配一亿次才能得到结果，用大O标记法就是O(n)最坏时间复杂度，这是无法接受的。</p> <p>而且这一亿条数据显然不能一次性读入内存供程序使用， 因此， 这一亿次匹配在不经缓存优化的情况下就是一亿次IO开销，以现在磁盘的IO能力和CPU的运算能力， 有可能需要几个月才能得出结果。</p> <p>如果把这张表转换成平衡树结构（一棵非常茂盛和节点非常多的树），假设这棵树有10层，那么只需要10次IO开销就能查找到所需要的数据。</p> <h5 id="为什么加索引后会使写入、修改、删除变慢？"><a href="#为什么加索引后会使写入、修改、删除变慢？" class="header-anchor">#</a> 为什么加索引后会使写入、修改、删除变慢？</h5> <p>因为平衡树这个结构必须一直维持在一个正确的状态， 增删改数据都会改变平衡树各节点中的索引数据内容，破坏树结构， 因此，在每次数据改变时， DBMS（数据库管理系统）必须去重新梳理树（索引）的结构以确保它的正确，这会带来不小的性能开销，也就是为什么索引会给查询以外的操作带来副作用的原因。</p> <h5 id="为啥不用二叉查找树呢？"><a href="#为啥不用二叉查找树呢？" class="header-anchor">#</a> 为啥不用二叉查找树呢？</h5> <p><a href="https://zhuanlan.zhihu.com/p/87124501" target="_blank" rel="noopener noreferrer">参考<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>如果是查找效率（即比较次数）的话，实际上二叉树可以说是最快的了，但是，我们的文件索引是存放在磁盘上的，所以我们不仅要考虑查找效率，还要考虑<strong>磁盘的寻址加载次数</strong></p> <p>首先磁盘里的数据加载到内存中的时候，是以页为单位来加载的，而节点与节点之间的数据是不连续的，<strong>所以不同的节点，很有可能分布在不同的磁盘页中</strong></p> <p>并且内存的运算速度是非常快的，至少比磁盘的寻址加载速度，快了几百倍。我们进行数值比较的时候，是在内存中进行的，虽然 B 树的比较次数可能比二叉查找树多，但是磁盘操作次数少，所以总体来说，还是 B 树快的多。</p> <h5 id="非聚合索引"><a href="#非聚合索引" class="header-anchor">#</a> 非聚合索引</h5> <p><code>非聚合索引</code>，也就是所谓的<code>常规索引</code></p> <p>如果给表中多个字段加上索引，那么就会出现多个独立的索引结构，每个索引（非聚集索引）互相之间不存在关联。每次给字段建一个新索引，字段中的数据就会被复制一份出来，用于生成索引。 因此，给表添加索引，会增加表的体积， 占用磁盘存储空间。</p> <p>非聚集索引和聚集索引的区别在于，通过聚集索引可以查到需要查找的数据，而通过非聚集索引可以查到记录对应的主键值 ，再使用主键的值通过聚集索引查找到需要的数据。</p> <p><strong>不管以任何方式查询表， 最终都会利用主键通过聚集索引来定位到数据， 聚集索引（主键）是通往真实数据所在的唯一路径。</strong>，</p> <p>然而， 有一种例外可以不使用聚集索引就能查询出所需要的数据， 这种非主流的方法 称之为 <code>覆盖索引</code> 查询， 也就是平时所说的 <code>复合索引</code> 或者 <code>多字段索引查询</code>。</p> <p>当为字段建立索引以后， 字段中的内容会被同步到索引之中，如果为一个索引指定两个字段，那么这个两个字段的内容都会被同步至索引之中。</p> <h5 id="索引的反例"><a href="#索引的反例" class="header-anchor">#</a> 索引的反例</h5> <ol><li>如果每次都需要取到所有表记录，无论如何都必须进行全表扫描了，那么是否加索引也没有意义了</li> <li>对非唯一的字段，例如“性别”这种大量重复值的字段，增加索引也没有什么意义</li> <li>对于记录比较少的表，增加索引不会带来速度的优化反而浪费了存储空间，因为索引是需要存储空间的
<ul><li>而且有个致命缺点是对于update/insert/delete的每次执行，字段的索引都必须重新计算更新。</li></ul></li></ol> <h5 id="不走索引的情况"><a href="#不走索引的情况" class="header-anchor">#</a> 不走索引的情况</h5> <p>有以下索引</p> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">key</span> <span class="token string">'idx_age'</span> <span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">key</span> <span class="token string">'idx_name'</span> <span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>索引用来计算不走索引</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code>    A:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> age <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">+</span><span class="token number">8</span>
    B:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> age <span class="token operator">+</span> <span class="token number">8</span> <span class="token operator">=</span> <span class="token number">18</span>
</code></pre></div><ol start="2"><li>列用函数不走索引</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code>    A:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> name <span class="token operator">=</span> concat<span class="token punctuation">(</span><span class="token string">'王哈'</span><span class="token punctuation">,</span><span class="token string">'哈'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    B:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span>  concat<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span><span class="token string">'哈'</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token string">'王哈哈'</span><span class="token punctuation">;</span>

    <span class="token comment"># A走索引、B不走索引</span>
</code></pre></div><ol start="3"><li><code>!=</code> 不走索引</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code>    <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> age <span class="token operator">!=</span> <span class="token number">18</span>

    <span class="token comment"># != 不走索引</span>
</code></pre></div><ol start="4"><li>Like的 % 在前面的不走索引</li></ol> <div class="language-sql extra-class"><pre class="language-sql"><code>    A:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token string">'name'</span> <span class="token operator">like</span> <span class="token string">'王%'</span>
    B:<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> student <span class="token keyword">where</span> <span class="token string">'name'</span> <span class="token operator">like</span> <span class="token string">'%小'</span>
    
    <span class="token comment"># A走索引、B不走索引</span>
</code></pre></div><ol start="5"><li>隐式转换导致不走索引</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/fed-note/java/begin.html" class="prev">
        Java常识
      </a></span> <span class="next"><a href="/fed-note/java/spring_boot.html">
        SpringBoot
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/fed-note/assets/js/app.52597b60.js" defer></script><script src="/fed-note/assets/js/2.666d6ac5.js" defer></script><script src="/fed-note/assets/js/10.bc70263e.js" defer></script>
  </body>
</html>
